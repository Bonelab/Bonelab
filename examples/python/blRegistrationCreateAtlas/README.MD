# blRegistrationCreateAtlas Examples

*Written by: Nathan Neeteson*\
*Last edited: 2023-06-05*

This folder serves to demonstrate how to use `blRegistrationCreateAtlas`

## 0) Setup

You are intended to be in this directory 
(`Bonelab/examples/python/blRegistrationCreateAtlas`) when executing these commands.
Please do not add any of the files generated by 
running these examples to be tracked by git.

First, run the python script to generate the test images and set up the example 
sub-directory structure:

```commandline
python generate_test_images.py
```
A figure will pop up to show 4 images being created, which are a cube and then some
randomly deformed cubes. Each image has a corresponding mask/segmentation.

Close the window to complete the script.

## 1) Commands

We can create an average atlas from this set of images and masks using the 
`blRegistrationCreatAtlas` command.

To see the full list of options for this command, 
copy the following command to the terminal:
```commandline
blRegistrationCreateAtlas -h
```

The output of this (at the time this README was written) is given at the bottom of the README.




## X) Command Options

```
usage: blRegistrationCreateAtlas [-h] --images IMAGES [IMAGES ...]
                                 --segmentations SEGMENTATIONS
                                 [SEGMENTATIONS ...] [--overwrite]
                                 [--binarize-segmentations]
                                 [--downsampling-shrink-factor X]
                                 [--downsampling-smoothing-sigma X]
                                 [--atlas-iterations N] [--atlas-sor-alpha X]
                                 [--atlas-convergence-threshold X]
                                 [--write-intermediate-atlases]
                                 [--cumulative-transforms]
                                 [--shrink-factors X [X ...]]
                                 [--smoothing-sigmas X [X ...]]
                                 [--max-affine-iterations N] [--optimizer STR]
                                 [--gradient-descent-learning-rate X]
                                 [--gradient-descent-convergence-min-value X]
                                 [--gradient-descent-convergence-window-size N]
                                 [--powell_max_line_iterations N]
                                 [--powell_step_length X]
                                 [--powell_step_tolerance X]
                                 [--powell_value_tolerance X]
                                 [--similarity-metric STR]
                                 [--similarity-metric-sampling-strategy STR]
                                 [--similarity-metric-sampling-rate P]
                                 [--similarity-metric-sampling-seed N]
                                 [--mutual-information-num-histogram-bins N]
                                 [--joint-mutual-information-joint-smoothing-variance X]
                                 [--interpolator STR]
                                 [--max-demons-iterations N]
                                 [--demons-type STR]
                                 [--displacement-smoothing-std X]
                                 [--update-smoothing-std X] [--silent]
                                 [--plot-metric-history]
                                 ATLAS_AVERAGE ATLAS_SEGMENTATION

This tool generates a segmented average-atlas image from a list of images with
segmentations. The atlas generation procedure was originally published in (1)
and was evaluated in (2). The steps of the procedure are: (1) Select the first
image given in the list as the atlas image, (2) affinely register all other
images to the atlas image, (3) transform all images to the space of the atlas
image, compute the average image, and set this as the new atlas image, (4)
deformably register all images to the atlas image, (5) transform all images to
the space of the atlas image, re-compute the average image, and set this as
the new atlas image, (6) repeat steps 4 and 5 until the atlas image has
converged, (7) deformably register all images to the final atlas image, (8)
transform all segmentations to the atlas space using nearest neighbour
interpolation, (9) use voting to generate the atlas segmentation, (10) write
the average-atlas and atlas segmentation to file. The user is given all of of
the necessary command line options to configure both the affine and deformable
registration parameters so that the method of atlas generation can be
consistent with the method of atlas-based segmentation using the atlas.

positional arguments:
  ATLAS_AVERAGE         Provide output filename for the average-atlas image
                        (.nii, .nii.gz).
  ATLAS_SEGMENTATION    Provide output filename for the atlas segmentation
                        image (.nii, .nii.gz).

optional arguments:
  -h, --help            show this help message and exit
  --images IMAGES [IMAGES ...], -img IMAGES [IMAGES ...]
                        Provide image filenames (.aim, .nii, .nii.gz).
                        (default: None)
  --segmentations SEGMENTATIONS [SEGMENTATIONS ...], -seg SEGMENTATIONS [SEGMENTATIONS ...]
                        Provide image filenames (.aim, .nii, .nii.gz).
                        (default: None)
  --overwrite, -ow      enable this flag to overwrite existing files, if they
                        exist at output targets (default: False)
  --binarize-segmentations, -bs
                        enable this flag to combine all masks into a binary
                        segmentation for all images (default: False)
  --downsampling-shrink-factor X, -dsf X
                        the shrink factor to apply to the fixed and moving
                        image before starting the registration (default: None)
  --downsampling-smoothing-sigma X, -dss X
                        the smoothing sigma to apply to the fixed and moving
                        image before starting the registration (default: None)
  --atlas-iterations N, -ai N
                        number of iterations when updating the atlas (default:
                        100)
  --atlas-sor-alpha X, -sora X
                        alpha value for successive over-relaxation (sor) of
                        atlas update. must be >0. decrease to improve
                        stability (but slow it down) or increase to speed up
                        convergence (but risk instability). (default: 1.0)
  --atlas-convergence-threshold X, -act X
                        threshold for convergence of atlas updates (default:
                        0.001)
  --write-intermediate-atlases, -wia
                        enable this flag to write out the average atlas image
                        at the end of each iteration (default: False)
  --cumulative-transforms, -ct
                        enable this flag to cumulatively deform transforms
                        between iterations, the default behaviour is to start
                        over with a new centered deformable transform for each
                        image at each iteration (default: False)
  --shrink-factors X [X ...], -sf X [X ...]
                        factors by which to shrink the fixed and moving image
                        at each stage of the multiscale progression. you must
                        give the same number of arguments here as you do for
                        `smoothing-sigmas` (default: None)
  --smoothing-sigmas X [X ...], -ss X [X ...]
                        sigmas for the Gaussians used to smooth the fixed and
                        moving image at each stage of the multiscale
                        progression. you must give the same number of
                        arguments here as you do for `shrink-factors`
                        (default: None)
  --max-affine-iterations N, -mai N
                        number of iterations to run registration algorithm for
                        at each stage in the affine registration (default:
                        100)
  --optimizer STR, -opt STR
                        the optimizer to use, options: `GradientDescent`,
                        `Powell` (default: GradientDescent)
  --gradient-descent-learning-rate X, -gdlr X
                        learning rate when using gradient descent optimizer
                        (default: 0.001)
  --gradient-descent-convergence-min-value X, -gdcmv X
                        minimum value for convergence when using gradient
                        descent optimizer (default: 1e-06)
  --gradient-descent-convergence-window-size N, -gdcws N
                        window size for checking for convergence when using
                        gradient descent optimizer (default: 10)
  --powell_max_line_iterations N, -pmli N
                        maximum number of line iterations when using Powell
                        optimizer (default: 100)
  --powell_step_length X, -psl X
                        maximum step length when using Powell optimizer
                        (default: 1.0)
  --powell_step_tolerance X, -pst X
                        step tolerance when using Powell optimizer (default:
                        1e-06)
  --powell_value_tolerance X, -pvt X
                        value tolerance when using Powell optimizer (default:
                        1e-06)
  --similarity-metric STR, -sm STR
                        the similarity metric to use, options: `MeanSquares`,
                        `Correlation`, `JointHistogramMutualInformation`,
                        `MattesMutualInformation` (default: MeanSquares)
  --similarity-metric-sampling-strategy STR, -smss STR
                        sampling strategy for similarity metric, options:
                        `None` -> use all points, `Regular` -> sample on a
                        regular grid with specified sampling rate, `Random` ->
                        sample randomly with specified sampling rate.
                        (default: None)
  --similarity-metric-sampling-rate P, -smsr P
                        sampling rate for similarity metric, must be between
                        0.0 and 1.0 (default: 0.2)
  --similarity-metric-sampling-seed N, -smssd N
                        the seed for random sampling, leave as `None` if you
                        want a random seed. Can be useful if you want a
                        deterministic registration with random sampling for
                        debugging/testing. Don't go crazy and use huge numbers
                        since SITK might report an OverflowError. I found
                        keeping it <=255 worked. (default: None)
  --mutual-information-num-histogram-bins N, -minhb N
                        number of bins in histogram when using joint histogram
                        or Mattes mutual information similarity metrics
                        (default: 20)
  --joint-mutual-information-joint-smoothing-variance X, -jmijsv X
                        variance to use when smoothing the joint PDF when
                        using the joint histogram mutual information
                        similarity metric (default: 1.5)
  --interpolator STR, -int STR
                        the interpolator to use, options: `Linear`,
                        `NearestNeighbour`, `BSpline` (default: Linear)
  --max-demons-iterations N, -mdi N
                        number of iterations to run registration algorithm for
                        at each stage in the demons registration (default:
                        100)
  --demons-type STR, -dt STR
                        type of demons algorithm to use. options: ['demons',
                        'diffeomorphic', 'symmetric', 'fast_symmetric']
                        (default: demons)
  --displacement-smoothing-std X, -ds X
                        standard deviation for the Gaussian smoothing applied
                        to the displacement field at each step.this is how you
                        control the elasticity of the smoothing of the
                        deformation (default: 1.0)
  --update-smoothing-std X, -us X
                        standard deviation for the Gaussian smoothing applied
                        to the update field at each step.this is how you
                        control the viscosity of the smoothing of the
                        deformation (default: 1.0)
  --silent, -s          enable this flag to suppress terminal output about how
                        the registration is proceeding (default: False)
  --plot-metric-history, -pmh
                        enable this flag to save a plot of the metric history
                        to file in addition to the raw data (default: False)

(1) DOI: 10.1109/MMBIA.2001.991733, (2) DOI: 10.1016/j.neuroimage.2003.11.010
```