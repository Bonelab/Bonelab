# blRegistration Examples

*Written by: Nathan Neeteson*\
*Last edited: 2023-03-01*

This folder serves to demonstrate how to use `blRegistration`, `blRegistrationApplyTransform`,
`blRegistrationDemons`, and `blImageComputeOverlap`.

Before doing anything, be sure that you have the bonelab env activated and the commands used in this README are 
installed. If they are not, then do a `git pull` and redo a `pip install -e .` from the root directory of the repo
to make sure you are up-to-date.

## 0) Setup

You are intended to be in this directory (`Bonelab/examples/python/blRegistration`) when executing these commands.
Please do not add any of the files generated by running these examples to be tracked by git.

First, run the python script to generate the test images and set up the example sub-directory structure:

```commandline
python generate_test_images.py
```

A figure will pop up showing you the 5 images that are being generated.
Close the figure to let the script finish. This script will create 4 sub-directories: 
`data`, `registration`, `transformed_masks`, and `overlap_metrics`,
and will also generate 5 synthetic images and corresponding masks in the `data` sub-directory:
`base.nii`, `translated.nii`, `rotated.nii`, `stretched.nii`, and `squashed.nii`.
The base image is a centered cube with an intensity gradient in all directions, and the other 4 images contain the same
cube but with various transformations synthetically applied. All the images also have some uniform noise added.
We will use these images to demonstrate registration - to test if the registration has worked we will use the resultant 
transformations to transform masks from the moving domain back to the fixed domain and see how well they line up
using standard overlap metrics.

## 1) Commands

The translated and rotated images can be rigidly registered to the base image.
Rigid registration is performed with `blRegistration`. To see a full list of the options for `blRegistration`, and 
what they do, copy the following command to the terminal:

```commandline
blRegistration -h
```

The stretched and squashed images could be affinely registered to the base image, but we will use deformable 
registration for demonstrative purposes.
Deformable registration is performed with `blRegistrationDemons`. 
To see a full list of the options for `blRegistrationDemons`, and 
what they do, copy the following command to the terminal:

```commandline
blRegistrationDemons -h
```

To apply transformations (rigid or deormable) to images, use the `blRegistrationApplyTransform` tool. 
To see a full list of the options for `blRegistrationApplyTransform`, and what they do, 
copy the following command to the terminal:

```commandline
blRegistrationApplyTransform -h
```

Finally, to compute Dice and Jaccard for two masks to quantify their overlap, use the `blImageComputeOverlap` tool.
To see a full list of the options for `blImageComputeOverlap`, and what they do, 
copy the following command to the terminal:

```commandline
blImageComputeOverlap -h
```

## 2) Rigid

### 2.1) `base.nii` &rarr; `translated.nii`

To register the translated image to the base image and put the registration outputs into the `registration`
sub-directory, copy the following command into the terminal:

```commandline
blRegistration data/base.nii data/translated.nii registration/base_to_translated.txt -pmh -ow -opt Powell -psl 0.1 -mi 100 -ci Moments -sf 4 2 1 -ss 2 1 0 -sm Correlation
```

This will use the Powell optimizer, the Correlation metric, a Moments initialization, 
and a typical 4-2-1 multiscale progression, among other parameters that are being specified (somewhat arbitrarily). 

Now the `registration` sub-directory should contain: 
- a `yaml` file with the parameters of the registration,
- a plain-text (`txt`) file containing the rigid deformation parameters,
- a `csv` file containing the value of the registration metric at each iteration, and
- a `png` file containing a plot of the registration metric at each iteration.

To apply this transformation to put the translated mask back into the frame of the base image, copy the following
command into the terminal:

```commandline
blRegistrationApplyTransform data/translated_mask.nii registration/base_to_translated.txt transformed_masks/translated_mask.nii
```

> **_NOTE:_**  You create a registration by specifying a FIXED and MOVING image, and the resulting registration will
> map from the MOVING frame to the FIXED frame. See above where we specified `data/base.nii` as FIXED and 
> `data/translated.nii` as MOVING, then applied the resulting transformation to `data/translated_mask.nii` to
> transform it into the frame of `data/base.nii`

Now the `transformed_masks` sub-directory should contain the following image: `translated_mask.nii`.

You can load the base image and the transformed translated mask using ITK-Snap or MITK-Gem to subjectively assess
how well the transformation worked, or you can compute the overlap of the transformed translated mask 
with the base mask by copying the following command into the terminal:

```commandline
blImageComputeOverlap data/base_mask.nii transformed_masks/translated_mask.nii overlap_metrics/translated.csv
```

Now the `overlap_metrics` sub-directory contains the following csv file: `translated.csv`.
You can look in this file, or just look at the terminal output from running the last command, to see the Dice and 
Jaccard for our transformed mask. When I ran these example commands, I got Dice of 0.86 and Jaccard of 0.76.

### 2.2) `base.nii` &rarr; `rotated.nii`

The sequence for registering, transforming, and analyzing the rotated image is the same as for the translated image,
so the terminal commands are given below without the commentary:

```commandline
blRegistration data/base.nii data/rotated.nii registration/base_to_rotated.txt -pmh -ow -opt Powell -psl 0.1 -mi 100 -ci Moments -sf 4 2 1 -ss 2 1 0 -sm Correlation
blRegistrationApplyTransform data/rotated_mask.nii registration/base_to_rotated.txt transformed_masks/rotated_mask.nii
blImageComputeOverlap data/base_mask.nii transformed_masks/rotated_mask.nii overlap_metrics/rotated.csv
```

When I ran these example commands, I got Dice of 0.79 and Jaccard of 0.65. The overlap is worse than for the translated
cube, which is not surprising given the amount of digital artifacts that happen when rotating a low-resolution image
by 45 degrees.

## 3) Deformable

### 3.1) `base.nii` &rarr; `stretched.nii`

To register the stretched image to the base image and put the registration outputs into the `registration`
sub-directory, copy the following command into the terminal:

```commandline
blRegistrationDemons data/base.nii data/stretched.nii registration/base_to_stretched.nii -sf 4 2 -ss 2 1 -pmh -ow -mi 100 -dt diffeomorphic -ds 0.1 -us 0.1 -wdv -vgsp 5 -vgsg 0.01
```

This will use the diffeomorphic Demons registration filter with a typical 4-2-1 multiscale progression and again
a handful of other parameters selected somewhat arbitrarily. 

Now the `registration` sub-directory will contain the following outputs:
- a `yaml` file with the parameters of the registration,
- a `nii` image containing the deformable registration,
- another `nii` image containing the deformable registration applied to a grid image for visualization purposes,
- a `csv` file containing the value of the registration metric at each iteration, and
- a `png` file containing a plot of the registration metric at each iteration.

To apply this transformation to put the stretched mask back into the frame of the base image, copy the following
command into the terminal:

```commandline
blRegistrationApplyTransform data/stretched_mask.nii registration/base_to_stretched.nii transformed_masks/stretched_mask.nii
```

> **_NOTE:_**  `blRegistrationApplyTransform` can be used to apply *any* SimpleITK transform to an image, provided
> that the transform can be read by `SimpleITK.ReadTransform` or is stored in a `nii` or `nii.gz` as a dense 
> displacement field.

Now the `transformed_masks` sub-directory should contain the following image: `stretched_mask.nii`.

You can load the base image and the transformed stretched mask using ITK-Snap or MITK-Gem to subjectively assess
how well the transformation worked, or you can compute the overlap of the transformed stretched mask 
with the base mask by copying the following command into the terminal:

```commandline
blImageComputeOverlap data/base_mask.nii transformed_masks/stretched_mask.nii overlap_metrics/stretched.csv
```

Now the `overlap_metrics` sub-directory contains the following csv file: `stretched.csv`.
You can look in this file, or just look at the terminal output from running the last command, to see the Dice and 
Jaccard for our transformed mask. When I ran these example commands, I got Dice of 0.82 and Jaccard of 0.70.


### 3.2) `base.nii` &rarr; `squashed.nii`

The sequence for registering, transforming, and analyzing the squashed image is the same as for the stretched image,
so the terminal commands are given below without the commentary:

```commandline
blRegistrationDemons data/base.nii data/squashed.nii registration/base_to_squashed.nii -sf 4 2 -ss 2 1 -pmh -ow -mi 100 -dt diffeomorphic -ds 0.1 -us 0.1 -wdv -vgsp 5 -vgsg 0.01
blRegistrationApplyTransform data/squashed_mask.nii registration/base_to_squashed.nii transformed_masks/squashed_mask.nii
blImageComputeOverlap data/base_mask.nii transformed_masks/squashed_mask.nii overlap_metrics/squashed.csv
```

When I ran these example commands, I got Dice of 0.87 and Jaccard of 0.77.